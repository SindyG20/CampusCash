<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employee Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { margin: 0; font-family: Arial, sans-serif; display: flex; background: #ecf0f1; }
  .sidebar { width: 220px; background: #2c3e50; color: white; height: 100vh; position: fixed; top: 0; left: 0; padding-top: 20px; }
  .sidebar h2 { text-align: center; margin-bottom: 30px; font-size: 20px; }
  .sidebar a { display: block; padding: 15px 20px; color: white; text-decoration: none; transition: 0.3s; cursor: pointer; }
  .sidebar a:hover { background: #34495e; }
  .sidebar a.active { background: #2980b9; }
  .content { margin-left: 220px; padding: 20px; flex: 1; }
  .stats { display: flex; gap: 15px; margin-bottom: 20px; }
  .stat-box { background: white; padding: 20px; border-radius: 8px; flex: 1; text-align: center; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
  .stat-box h3 { margin: 0; font-size: 16px; color: #555; }
  .stat-box .number { font-size: 28px; font-weight: bold; color: #2c3e50; }
  table { width: 100%; border-collapse: collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 3px 8px rgba(0,0,0,0.1); }
  th, td { padding: 10px; border-bottom: 1px solid #ddd; vertical-align: middle; }
  th { background:#2980b9; color:white; text-align:left; }
  .card { background:white; padding:14px; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.06); margin-bottom:16px; }
  .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
  .controls input, .controls select { padding:8px; border-radius:6px; border:1px solid #ccc; }
  .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  .btn-primary { background:#2980b9; color:white; }
  .btn-approve { background:#2ecc71; color:white; }
  .btn-reject { background:#e74c3c; color:white; }
  .status-pill { padding:6px 8px; border-radius:999px; font-weight:600; display:inline-block; }
  .status-pending { background:#f39c12; color:white; }
  .status-approved { background:#2ecc71; color:white; }
  .status-rejected { background:#e74c3c; color:white; }
  .small { font-size:13px; color:#666; }
  @media (max-width:700px){ .controls { flex-direction:column; align-items:stretch; } }
  .edit-form input, .edit-form select, .edit-form textarea { padding:8px; border:1px solid #ccc; border-radius:6px; width:100%; box-sizing:border-box; margin-bottom:8px; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Employee Menu</h2>
  <a class="active" data-target="reports"><i class="fas fa-chart-line"></i> Generate Reports</a>
  <a data-target="appointments"><i class="fas fa-calendar-check"></i> Appointments</a>
  <a href="employee-index.html"><i class="fas fa-arrow-left"></i> Logout</a>
</div>

<div class="content">
  <!-- Reports Section (now pulls transactions from frontend) -->
  <div class="section" id="reports">
    <h1>Transaction Reports</h1>

    <!-- Search / filters -->
    <div style="margin-bottom:20px;">
      <input type="text" id="txSearch" placeholder="Search by from/to or type..." style="padding:10px; width:300px; border-radius:6px; border:1px solid #ccc; margin-right:10px;">
      <input type="date" id="txDate" style="padding:10px; border-radius:6px; border:1px solid #ccc; margin-right:10px;">
      <select id="txType" style="padding:10px; border-radius:6px; border:1px solid #ccc; margin-right:10px;">
        <option value="">All Types</option>
        <option value="deposit">Deposit</option>
        <option value="withdraw">Withdraw</option>
        <option value="transfer">Transfer</option>
      </select>
      <button id="txFilterBtn" class="btn btn-primary">Filter</button>
      <button id="txClearBtn" class="btn">Clear</button>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-box">
        <h3>Total Transactions</h3>
        <div class="number" id="totalTx">0</div>
        <div class="muted">Count</div>
      </div>
      <div class="stat-box">
        <h3>Total Value (R)</h3>
        <div class="number" id="totalValue">R0.00</div>
        <div class="muted">Sum of amounts</div>
      </div>
      <div class="stat-box">
        <h3>Suspicious / Pending</h3>
        <div class="number" id="txFlagged">0</div>
        <div class="muted">Flagged transactions</div>
      </div>
    </div>

    <!-- Transactions table -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount (R)</th>
            <th>From</th>
            <th>To</th>
            <th>Type</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="txTableBody"></tbody>
      </table>
      <div class="small" style="margin-top:8px;">This view reads the `transactions` array from localStorage — the same key your frontend `reports.html` uses.</div>
    </div>
  </div>

  <!-- Appointments Section (employee-managed; reads per-student keys appointments_*) -->
  <div class="section" id="appointments" style="display:none;">
    <h1>Manage Appointments</h1>

    <div class="card controls">
      <input id="apptSearch" placeholder="Search by name, student no or purpose..." style="min-width:220px;">
      <select id="apptStatusFilter">
        <option value="">All statuses</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
      <input id="apptDateFilter" type="date">
      <button id="apptClearFilters" class="btn">Clear</button>

      <div style="margin-left:auto; text-align:right;">
        <div class="small">Total: <span id="apptTotal">0</span></div>
        <div class="small">Pending: <span id="apptPending">0</span></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Appointments</h3>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Student No.</th>
            <th>Date / Time</th>
            <th>Purpose</th>
            <th>Status</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody id="apptTableBody"></tbody>
      </table>
      <div class="small" style="margin-top:8px;">This view reads appointments stored by the frontend under keys that start with <code>appointments_</code>. Changes made here are saved back to each student's appointment key.</div>
    </div>

    <div class="card" id="editCard" style="display:none;">
      <h3 style="margin-top:0;">Edit Appointment</h3>
      <form id="editForm" class="edit-form">
        <input type="hidden" id="editId">
        <label>Student Name</label>
        <input id="editName" required>
        <label>Student Number</label>
        <input id="editStudentNumber" required>
        <label>Date</label>
        <input id="editDate" type="date" required>
        <label>Time</label>
        <input id="editTime" type="time" required>
        <label>Purpose</label>
        <input id="editPurpose" required>
        <label>Status</label>
        <select id="editStatus">
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button class="btn btn-primary" type="submit">Save</button>
          <button type="button" id="cancelEdit" class="btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
// Sidebar nav
const sidebarLinks = document.querySelectorAll('.sidebar a[data-target]');
const sections = document.querySelectorAll('.section');

sidebarLinks.forEach(link => {
  link.addEventListener('click', () => {
    sidebarLinks.forEach(l => l.classList.remove('active'));
    sections.forEach(s => s.style.display = 'none');

    link.classList.add('active');
    const target = link.getAttribute('data-target');
    document.getElementById(target).style.display = 'block';
    if (target === 'appointments') renderAppointments();
  });
});

// --------------------- Reports (reads frontend transactions) ---------------------
function loadTransactions(){
  try {
    const txt = localStorage.getItem('transactions') || '[]';
    const arr = JSON.parse(txt);
    if (!Array.isArray(arr)) return [];
    return arr.map(tx => {
      // normalize fields and ensure types
      return {
        date: tx.date || tx.createdAt || '',
        amount: (typeof tx.amount === 'string' || typeof tx.amount === 'number') ? parseFloat(tx.amount || 0) : 0,
        from: tx.from || tx.fromAccount || tx.source || '-',
        to: tx.to || tx.toAccount || tx.destination || '-',
        type: (tx.type || '').toLowerCase(),
        note: tx.note || tx.noteText || tx.description || ''
      };
    });
  } catch(e){
    console.error('Error loading transactions:', e);
    return [];
  }
}

const txSearch = document.getElementById('txSearch');
const txDate = document.getElementById('txDate');
const txType = document.getElementById('txType');
const txFilterBtn = document.getElementById('txFilterBtn');
const txClearBtn = document.getElementById('txClearBtn');
const txTableBody = document.getElementById('txTableBody');
const totalTxEl = document.getElementById('totalTx');
const totalValueEl = document.getElementById('totalValue');
const txFlaggedEl = document.getElementById('txFlagged');

function renderTransactionsView(){
  const all = loadTransactions();
  const q = (txSearch.value || '').trim().toLowerCase();
  const dateFilter = txDate.value;
  const typeFilter = txType.value;

  const filtered = all.filter(tx => {
    let ok = true;
    if (q) {
      ok = (String(tx.from || '').toLowerCase().includes(q) || String(tx.to || '').toLowerCase().includes(q) || String(tx.type || '').toLowerCase().includes(q) || String(tx.note || '').toLowerCase().includes(q));
    }
    if (ok && dateFilter) ok = tx.date === dateFilter;
    if (ok && typeFilter) ok = tx.type === typeFilter;
    return ok;
  }).slice().reverse();

  // render table
  txTableBody.innerHTML = '';
  filtered.forEach(tx => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(tx.date)}</td>
      <td>R${(Number(tx.amount) || 0).toFixed(2)}</td>
      <td>${escapeHtml(tx.from)}</td>
      <td>${escapeHtml(tx.to)}</td>
      <td>${escapeHtml((tx.type || '').charAt(0).toUpperCase() + (tx.type || '').slice(1))}</td>
      <td>${escapeHtml(tx.note || '')}</td>
    `;
    txTableBody.appendChild(tr);
  });

  // stats
  const totalCount = all.length;
  const totalValue = all.reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
  // flagged heuristic: transactions where amount is > 10000 or missing 'from'/'to' — adjust to suit your rules
  const flagged = all.filter(t => (Number(t.amount) || 0) > 10000 || t.from === '-' || t.to === '-').length;

  totalTxEl.innerText = totalCount;
  totalValueEl.innerText = 'R' + totalValue.toFixed(2);
  txFlaggedEl.innerText = flagged;
}

function escapeHtml(s){ return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

txFilterBtn.addEventListener('click', renderTransactionsView);
txClearBtn.addEventListener('click', function(){
  txSearch.value = ''; txDate.value = ''; txType.value = ''; renderTransactionsView();
});
txSearch.addEventListener('input', renderTransactionsView);
txDate.addEventListener('change', renderTransactionsView);
txType.addEventListener('change', renderTransactionsView);

// initial render
renderTransactionsView();

// --------------------- Appointments logic (unchanged) ---------------------
function generateId(){ return 'a_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function loadAllAppointments(){
  const items = [];
  for (let i = 0; i < localStorage.length; i++){
    const key = localStorage.key(i);
    if (!key) continue;
    if (key.startsWith('appointments_')){
      try {
        const arr = JSON.parse(localStorage.getItem(key)) || [];
        arr.forEach(a => {
          const copy = Object.assign({}, a);
          if (copy.fullName && !copy.name){ copy.name = copy.fullName; }
          if (!copy.name && copy.studentName) copy.name = copy.studentName;
          if (!copy.studentNumber && copy.studentNo) copy.studentNumber = copy.studentNo;
          if (!copy.studentNumber && key.indexOf('_') !== -1) {
            const parts = key.split('_'); if (parts.length >= 2) copy.studentNumber = copy.studentNumber || parts.slice(1).join('_');
          }
          if (!copy.id) copy.id = generateId();
          if (!copy.status) copy.status = 'pending';
          copy._originKey = key;
          items.push(copy);
        });
      } catch(e){
        console.warn('Could not parse', key, e);
      }
    }
  }
  return items;
}

function saveAppointmentToOrigin(appointment){
  if (!appointment || !appointment._originKey) return;
  try {
    const key = appointment._originKey;
    const arr = JSON.parse(localStorage.getItem(key)) || [];
    const idx = arr.findIndex(x => x.id === appointment.id || (x.date === appointment.date && x.time === appointment.time && (x.studentNumber === appointment.studentNumber || x.studentNo === appointment.studentNumber)));
    if (idx !== -1){
      arr[idx] = stripInternalFields(appointment);
    } else {
      arr.push(stripInternalFields(appointment));
    }
    localStorage.setItem(key, JSON.stringify(arr));
  } catch(e){
    console.error('Failed to save appointment to origin', e);
  }
}

function deleteAppointmentFromOrigin(appointment){
  if (!appointment || !appointment._originKey) return;
  try {
    const key = appointment._originKey;
    const arr = JSON.parse(localStorage.getItem(key)) || [];
    const idx = arr.findIndex(x => x.id === appointment.id || (x.date === appointment.date && x.time === appointment.time && (x.studentNumber === appointment.studentNumber || x.studentNo === appointment.studentNumber)));
    if (idx !== -1){
      arr.splice(idx,1);
      localStorage.setItem(key, JSON.stringify(arr));
    }
  } catch(e){
    console.error('Failed to delete appointment from origin', e);
  }
}

function stripInternalFields(a){
  const copy = Object.assign({}, a);
  delete copy._originKey;
  return copy;
}

const apptTableBody = document.getElementById('apptTableBody');
const apptSearch = document.getElementById('apptSearch');
const apptStatusFilter = document.getElementById('apptStatusFilter');
const apptDateFilter = document.getElementById('apptDateFilter');
const apptClearFilters = document.getElementById('apptClearFilters');
const apptTotal = document.getElementById('apptTotal');
const apptPending = document.getElementById('apptPending');

const editCard = document.getElementById('editCard');
const editForm = document.getElementById('editForm');
const editId = document.getElementById('editId');
const editName = document.getElementById('editName');
const editStudentNumber = document.getElementById('editStudentNumber');
const editDate = document.getElementById('editDate');
const editTime = document.getElementById('editTime');
const editPurpose = document.getElementById('editPurpose');
const editStatus = document.getElementById('editStatus');
const cancelEdit = document.getElementById('cancelEdit');

function statusHtml(status){
  if (status === 'pending') return '<span class="status-pill status-pending">Pending</span>';
  if (status === 'approved') return '<span class="status-pill status-approved">Approved</span>';
  if (status === 'rejected') return '<span class="status-pill status-rejected">Rejected</span>';
  return `<span class="status-pill">${escapeHtml(status)}</span>`;
}

function renderAppointments(){
  const list = loadAllAppointments();
  const q = (apptSearch.value || '').trim().toLowerCase();
  const statusFilter = apptStatusFilter.value;
  const dateFilter = apptDateFilter.value;

  const filtered = list.filter(a => {
    let ok = true;
    if (q){
      ok = (a.name || '').toLowerCase().includes(q) || (a.studentNumber || '').toLowerCase().includes(q) || (a.purpose || '').toLowerCase().includes(q);
    }
    if (ok && statusFilter) ok = a.status === statusFilter;
    if (ok && dateFilter) ok = a.date === dateFilter;
    return ok;
  }).sort((x,y) => (x.date + ' ' + x.time) > (y.date + ' ' + y.time) ? 1 : -1);

  apptTableBody.innerHTML = '';
  filtered.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(a.name || a.studentName || '')}</td>
      <td>${escapeHtml(a.studentNumber || '')}</td>
      <td>${escapeHtml(a.date || '')} ${escapeHtml(a.time || '')}</td>
      <td>${escapeHtml(a.purpose || '')}</td>
      <td>${statusHtml(a.status)}</td>
      <td>
        <button class="btn btn-approve" data-action="approve" data-id="${a.id}" data-origin="${a._originKey}"><i class="fas fa-check"></i> Approve</button>
        <button class="btn btn-reject" data-action="reject" data-id="${a.id}" data-origin="${a._originKey}"><i class="fas fa-times"></i> Reject</button>
        <button class="btn" data-action="edit" data-id="${a.id}" data-origin="${a._originKey}"><i class="fas fa-edit"></i> Edit</button>
        <button class="btn" data-action="delete" data-id="${a.id}" data-origin="${a._originKey}"><i class="fas fa-trash"></i> Delete</button>
      </td>
    `;
    apptTableBody.appendChild(tr);
  });

  apptTotal.innerText = list.length;
  apptPending.innerText = list.filter(x => x.status === 'pending').length;
}

// delegation for appointment actions
apptTableBody.addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.getAttribute('data-action');
  const id = btn.getAttribute('data-id');
  const origin = btn.getAttribute('data-origin');

  if (!id || !origin) {
    alert('Origin key or id missing; cannot perform this action.');
    renderAppointments();
    return;
  }

  const arr = JSON.parse(localStorage.getItem(origin) || '[]');
  let idx = arr.findIndex(x => x.id === id);
  if (idx === -1) {
    idx = arr.findIndex(x => (x.date === btn.closest('tr').cells[2].innerText.split(' ')[0]) && (x.time === btn.closest('tr').cells[2].innerText.split(' ')[1]));
  }

  if (action === 'approve' || action === 'reject'){
    if (idx === -1){
      const all = loadAllAppointments();
      const found = all.find(x => x.id === id);
      if (!found) { alert('Appointment not found.'); renderAppointments(); return; }
      found.status = (action === 'approve') ? 'approved' : 'rejected';
      saveAppointmentToOrigin(found);
      renderAppointments();
      return;
    }
    if (!arr[idx].id) arr[idx].id = id;
    arr[idx].status = (action === 'approve') ? 'approved' : 'rejected';
    localStorage.setItem(origin, JSON.stringify(arr));
    renderAppointments();
  } else if (action === 'delete'){
    if (!confirm('Delete this appointment?')) return;
    if (idx !== -1) {
      arr.splice(idx,1);
      localStorage.setItem(origin, JSON.stringify(arr));
    } else {
      const all = loadAllAppointments();
      const found = all.find(x => x.id === id);
      if (found) deleteAppointmentFromOrigin(found);
    }
    renderAppointments();
  } else if (action === 'edit'){
    const all = loadAllAppointments();
    const apt = all.find(x => x.id === id && x._originKey === origin);
    if (!apt){ alert('Appointment not found for editing.'); return; }
    editId.value = apt.id;
    editName.value = apt.name || apt.studentName || '';
    editStudentNumber.value = apt.studentNumber || '';
    editDate.value = apt.date || '';
    editTime.value = apt.time || '';
    editPurpose.value = apt.purpose || '';
    editStatus.value = apt.status || 'pending';
    editForm.dataset.origin = apt._originKey;
    editCard.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
});

// handle edit form submit
editForm.addEventListener('submit', function(e){
  e.preventDefault();
  const id = editId.value;
  const origin = editForm.dataset.origin;
  if (!origin){
    alert('Missing origin key; cannot save.');
    return;
  }
  const arr = JSON.parse(localStorage.getItem(origin) || '[]');
  let idx = arr.findIndex(x => x.id === id);
  if (idx === -1){
    idx = arr.findIndex(x => x.date === editDate.value && x.time === editTime.value && (x.studentNumber === editStudentNumber.value || x.studentNo === editStudentNumber.value));
  }
  const updated = {
    id: id || generateId(),
    name: editName.value.trim(),
    studentNumber: editStudentNumber.value.trim(),
    date: editDate.value,
    time: editTime.value,
    purpose: editPurpose.value.trim(),
    status: editStatus.value
  };
  if (idx !== -1){
    const original = arr[idx];
    const merged = Object.assign({}, original, updated);
    arr[idx] = merged;
  } else {
    arr.push(updated);
  }
  localStorage.setItem(origin, JSON.stringify(arr));
  editCard.style.display = 'none';
  renderAppointments();
});

cancelEdit.addEventListener('click', function(){ editCard.style.display = 'none'; });

// appointment filters
apptSearch.addEventListener('input', renderAppointments);
apptStatusFilter.addEventListener('change', renderAppointments);
apptDateFilter.addEventListener('change', renderAppointments);
apptClearFilters.addEventListener('click', function(){
  apptSearch.value = '';
  apptStatusFilter.value = '';
  apptDateFilter.value = '';
  renderAppointments();
});

// Render initial state
renderTransactionsView();
renderAppointments();

</script>

</body>
</html>