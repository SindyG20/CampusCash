<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campus Cash — Profile</title>
  <style>
    /* Existing styles kept */
    :root{--bg:#f4f6f8;--card:#fff;--accent:#0b74da;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111}
    .container{max-width:960px;margin:40px auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .brand{font-weight:700;font-size:1.25rem}
    .nav{display:flex;gap:16px}
    .nav a{text-decoration:none;color:#374151;font-weight:500}
    .nav a:hover{color:var(--accent)}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(12,20,40,0.06);padding:24px;display:grid;grid-template-columns:140px 1fr;gap:20px;align-items:start}
    .avatar{width:120px;height:120px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,#e6eefc,#f7fbff);display:flex;align-items:center;justify-content:center;font-size:3rem;color:var(--muted)}
    .info h2{margin:0 0 6px 0;font-size:1.25rem}
    .info p{margin:0 4px 10px 0;color:var(--muted)}
    .meta{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
    .meta .chip{background:#f3f4f6;padding:8px 12px;border-radius:999px;font-size:0.9rem;color:#374151}
    .actions{display:flex;gap:8px;align-items:center;position:relative}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(11,116,218,0.12)}
    .settings-btn{background:transparent;border:0;cursor:pointer;padding:8px;border-radius:8px}
    .dropdown{position:absolute;top:110%;right:0;background:var(--card);border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.1);display:none;flex-direction:column;min-width:200px;z-index:50}
    .dropdown button{background:none;border:0;padding:12px 16px;text-align:left;cursor:pointer;font-size:0.95rem;color:#111}
    .dropdown button:hover{background:#f3f4f6}
    .modal-backdrop{position:fixed;inset:0;background:rgba(3,7,18,0.45);display:none;align-items:center;justify-content:center;padding:20px}
    .modal{background:var(--card);border-radius:12px;max-width:720px;width:100%;padding:20px;box-shadow:0 12px 40px rgba(8,10,20,0.3)}
    .modal h3{margin:0 0 12px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:0.9rem;margin-bottom:6px;color:#111}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;font-size:0.95rem}
    textarea{min-height:80px}
    .modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .small{font-size:0.85rem;color:var(--muted)}
    @media (max-width:700px){
      .card{grid-template-columns:1fr;}
      .form-grid{grid-template-columns:1fr}
    }
    .toast{position:fixed;right:20px;bottom:20px;background:#111;color:#fff;padding:12px 16px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="" alt="" width="40" height="40" style="border-radius:8px;background:linear-gradient(90deg,#0b74da,#00c6ff)"/>
        <div class="brand">Campus Cash</div>
      </div>
      <div class="nav">
        <a href="home.html">Home</a>
        <a href="profile.html">Profile</a>
        <a href="#">Accounts</a>
      </div>
      <div class="actions">
        <button id="settingsToggle" class="btn" title="Settings">Settings ▾</button>
        <div id="settingsDropdown" class="dropdown" role="menu" aria-hidden="true">
          <button id="editProfile" role="menuitem">Edit Profile</button>
          <button id="blockCard" role="menuitem">Block Card</button>
          <button id="replaceCard" role="menuitem">Replace Card</button>
          <button id="cardSettings" role="menuitem">Card Settings</button>
          <button id="cardLimits" role="menuitem">Card Limits</button>
          <button id="reportLost" role="menuitem">Report Lost / Stolen Card</button>
        </div>
        <button id="logout" class="btn secondary" title="Logout">Logout</button>
      </div>
    </div>

    <main class="card" role="region" aria-label="User profile">
      <div>
        <div id="avatar" class="avatar" aria-hidden="true">SG</div>
      </div>
      <div class="info">
        <div id="avatar" class="avatar" aria-hidden="true">--</div>
<h2 id="displayName">Loading...</h2>
<p id="displayEmail"></p>
<div class="chip" id="displayPhone"></div>
<div class="chip" id="displayMember">Member since: <span id="displaySince"></span></div>
<p class="small" id="displayAddress"></p>

      </div>
    </main>

  </div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h3>Edit profile</h3>
    <form id="profileForm">
      <div class="form-grid">
        <div>
          <label for="firstName">First name</label>
          <input id="firstName" name="firstName" type="text" required />
        </div>
        <div>
          <label for="lastName">Last name</label>
          <input id="lastName" name="lastName" type="text" required />
        </div>
        <div>
          <label for="email">Email</label>
          <input id="emailInput" name="email" type="email" required />
        </div>
        <div>
          <label for="phone">Phone</label>
          <input id="phone" name="phone" type="tel" />
        </div>
        <div style="grid-column:1 / -1">
          <label for="address">Address</label>
          <textarea id="address" name="address"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelBtn" class="btn secondary">Cancel</button>
        <button type="submit" class="btn">Save changes</button>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

<script>
const storageKey = 'user'; // localStorage key for current user

// Format ISO date nicely
function formatDate(isoDate){
  if(!isoDate) return '';
  const date = new Date(isoDate);
  return date.toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });
}

// Build a full name from localStorage
function getFullName(profile){
  if(profile.fullName && profile.fullName.trim()) return profile.fullName.trim();

  const first = profile.firstName || '';
  const last = profile.lastName || '';
  if(first || last) return (first + ' ' + last).trim();

  if(profile.email) return profile.email.split('@')[0];

  return 'User';
}

// Update profile display
function updateDisplay(profile){
  const fullName = getFullName(profile);

  document.getElementById('displayName').textContent = fullName;
  document.getElementById('displayEmail').textContent = profile.email || '';
  document.getElementById('displayPhone').textContent = profile.contactNumber || '';
  document.getElementById('displayAddress').textContent = profile.address || '';
  document.getElementById('displaySince').textContent = formatDate(profile.createdAt || new Date().toISOString());

  const initials = fullName.split(' ').map(n=>n[0]||'').join('').toUpperCase();
  document.getElementById('avatar').textContent = initials;
}

// Clear old localStorage if needed
function resetLocalStorageIfOld(){
  const oldUser = JSON.parse(localStorage.getItem(storageKey) || '{}');
  if(oldUser.displayName === "Sindy Gumede" || !oldUser.studentNumber){
    localStorage.removeItem(storageKey);
  }
}

// Load user from localStorage (or backend if available)
async function loadUser(){
  resetLocalStorageIfOld(); // remove stale data

  let currentUser = JSON.parse(localStorage.getItem(storageKey) || '{}');

  // If localStorage is empty, show placeholder
  if(!currentUser || Object.keys(currentUser).length === 0){
    console.warn("No user found in localStorage. Using placeholder.");
    currentUser = {
      firstName: '',
      lastName: '',
      email: '',
      contactNumber: '',
      address: '',
      createdAt: new Date().toISOString()
    };
  }

  // If studentNumber exists, fetch from backend
  if(currentUser.studentNumber){
    try{
      const res = await fetch(`http://localhost:5264/api/users/${currentUser.studentNumber}`);
      if(res.ok){
        const userFromDB = await res.json();

        userFromDB.createdAt = userFromDB.createdAt || currentUser.createdAt;
        userFromDB.fullName = userFromDB.fullName || `${userFromDB.firstName||''} ${userFromDB.lastName||''}`.trim();

        currentUser = userFromDB;
        localStorage.setItem(storageKey, JSON.stringify(currentUser));
      }
    }catch(e){
      console.warn('Failed to fetch user from backend, using localStorage.', e);
    }
  }

  updateDisplay(currentUser);
}

// Dropdown toggle
const settingsToggle = document.getElementById('settingsToggle');
const settingsDropdown = document.getElementById('settingsDropdown');

settingsToggle.addEventListener('click', (e) => {
  e.stopPropagation();
  const isVisible = settingsDropdown.style.display === 'flex';
  settingsDropdown.style.display = isVisible ? 'none' : 'flex';
});

// Close dropdown if clicked outside
document.addEventListener('click', (e) => {
  if (!settingsDropdown.contains(e.target) && e.target !== settingsToggle) {
    settingsDropdown.style.display = 'none';
  }
});

// Dropdown item links
document.getElementById('editProfile').addEventListener('click', () => {
  document.getElementById('modalBackdrop').style.display = 'flex';
  settingsDropdown.style.display = 'none'; // change to your edit profile page
});

document.getElementById('blockCard').addEventListener('click', () => {
  window.location.href = 'block-card.html'; // change to your block card page
});

document.getElementById('replaceCard').addEventListener('click', () => {
  window.location.href = 'Replace-card.html'; // change to your replace card page
});

document.getElementById('cardSettings').addEventListener('click', () => {
  window.location.href = 'cardSettings.html'; // change to your card settings page
});

document.getElementById('cardLimits').addEventListener('click', () => {
  window.location.href = 'cardLimits.html'; // change to your card limits page
});

document.getElementById('reportLost').addEventListener('click', () => {
  window.location.href = 'report-lost.html'; // change to your lost/stolen card page
});



// Run on page load
loadUser();
</script>




</body>
</html>
