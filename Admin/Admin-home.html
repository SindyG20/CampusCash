<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Dashboard - Campus Management System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* (kept your original styling, unchanged) */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Arial,sans-serif}
body{background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);background-size:400% 400%;animation:gradientBG 15s ease infinite;color:#333;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.container{display:flex;width:90%;max-width:1200px;height:85vh;background:rgba(255,255,255,0.95);border-radius:15px;overflow:hidden;box-shadow:0 15px 40px rgba(0,0,0,0.4)}
.sidebar{width:280px;background:#2c3e50;color:white;padding:25px 0;overflow-y:auto}
.logo{text-align:center;padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:20px}
.bank-logo{width:80px;height:80px;margin:0 auto 10px}
.bank-logo img{width:100%;height:100%;object-fit:contain;display:block}
.logo h1{font-size:20px;margin-top:0}
.menu-item{padding:15px 25px;display:flex;align-items:center;cursor:pointer;transition:all .3s ease;border-left:4px solid transparent}
.menu-item:hover{background:#34495e}
.menu-item.active{background:#3498db;border-left:4px solid #f1c40f}
.menu-item i{margin-right:15px;font-size:18px;width:24px;text-align:center}
.content{flex:1;padding:30px;overflow-y:auto}
.content-section{display:none}
.content-section.active{display:block}
h2{color:#2c3e50;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #3498db}
.stats{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:25px}
.stat-box{flex:1;min-width:200px;background:white;padding:20px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.08);text-align:center}
.stat-box h3{color:#7f8c8d;font-size:16px;margin-bottom:10px}
.stat-box .number{font-size:32px;font-weight:bold;color:#2c3e50}
.search-box{display:flex;margin-bottom:20px}
.search-box input{flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:4px 0 0 4px;font-size:16px}
.search-box button{background:#3498db;color:white;border:none;padding:0 20px;border-radius:0 4px 4px 0;cursor:pointer}
.action-btn{background:#27ae60;color:white;padding:8px 15px;margin-bottom:15px;border:none;border-radius:5px;cursor:pointer;transition:0.3s}
.action-btn:hover{background:#219150}
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-bottom:20px}
table th,table td{padding:12px;border:1px solid #ddd;text-align:left}
table th{background:#3498db;color:white}
.action-icons button{background:none;border:none;cursor:pointer;margin:0 5px;font-size:16px}
.action-icons .edit{color:#2980b9}
.action-icons .delete{color:#c0392b}
@media(max-width:900px){.container{flex-direction:column;height:auto}.sidebar{width:100%;height:auto}.menu-items{display:flex;flex-wrap:wrap;justify-content:center}.menu-item{flex:1;min-width:150px;justify-content:center;border-left:none;border-bottom:4px solid transparent}.menu-item.active{border-left:none;border-bottom:4px solid #f1c40f}}
@media(max-width:600px){.stats{flex-direction:column}.menu-item{min-width:100%}}
.small{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <div class="logo">
      <div class="bank-logo"><img src="logo.png" alt="NWU Bank Logo"></div>
      <h1>Campus Admin</h1>
    </div>
    <div class="menu-items">
      <div class="menu-item active" data-target="students"><i class="fas fa-user-graduate"></i><span>Managing Students</span></div>
      <div class="menu-item" data-target="employees"><i class="fas fa-users"></i><span>Maintaining Employees</span></div>
      <a href="Admin-index.html" style="color:#fff;display:block;padding:12px 25px;text-decoration:none"><i class="fas fa-arrow-left"></i> Logout</a>
    </div>
  </div>

  <div class="content">
    <div class="content-section active" id="students">
      <h2>Manage Students</h2>
      <div class="stats">
        <div class="stat-box"><h3>Total Students</h3><div class="number" id="totalStudents">0</div></div>
        <div class="stat-box"><h3>New This Month</h3><div class="number" id="newThisMonth">0</div></div>
        <div class="stat-box"><h3>Pending Actions</h3><div class="number" id="pendingStudents">0</div></div>
      </div>

      <div class="search-box">
        <input type="text" id="searchStudent" placeholder="Search by name or student number...">
        <button id="searchBtn"><i class="fas fa-search"></i></button>
      </div>

      <button class="action-btn" id="addStudentBtn"><i class="fas fa-plus"></i> Add Student</button>
      <div class="table-container">
        <table id="studentsTable">
          <thead>
            <tr><th>Student Number</th><th>Name</th><th>Email</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small">This admin reads registrations produced by your registration page. If you use a backend API, set <code>apiBaseUrl</code> in the script.</div>
    </div>
<!--EMPLOYEES-->
    <div class="content-section" id="employees">
      <h2>Manage Employees</h2>
      <div class="stats">
        <div class="stat-box"><h3>Total Employees</h3><div class="number" id="totalEmployees">0</div></div>
        <div class="stat-box"><h3>New This Month</h3><div class="number" id="newEmployeesThisMonth">0</div></div>
        <div class="stat-box"><h3>Pending Actions</h3><div class="number" id="pendingEmployees">0</div></div>
      </div>
      <div class="search-box">
        <input type="text" id="searchEmployee" placeholder="Search employees by name, ID, or role...">
        <button id="searchEmployeeBtn"><i class="fas fa-search"></i></button>
      </div>
      <button class="action-btn" id="addEmployeeBtn"><i class="fas fa-plus"></i> Add Employee</button>
      <div class="table-container">
        <table id="employeesTable">
          <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>

/*
 Admin script that:
  - Loads registrations from API (if apiBaseUrl set) or from localStorage keys.
  - Allows Add/Edit/Delete and writes back to the origin (API/localStorage).
  - Also keeps a 'users' array in localStorage so admin-created accounts can log in.
  - Extended to handle employees with similar functionality.
*/

// ---------- Configuration ----------
const apiBaseUrl = null; // set to e.g. "http://localhost:5264/api/students" if you have an API
const POSSIBLE_STUDENT_KEYS = ['registrations','students','registeredStudents','studentRegistrations'];
const POSSIBLE_EMPLOYEE_KEYS = ['employees','staff','employeeRegistrations'];
const USERS_KEY = 'users'; // localStorage key that stores login-capable users

// ---------- Helpers ----------
function generateId(){ return 'e_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function nowIso(){ return new Date().toISOString(); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function normalize(raw, type = 'student'){
  if(!raw) return null;
  if (type === 'employee') {
    return {
      id: raw.id || raw.employeeId || generateId(),
      employeeId: raw.employeeId || raw.id || '',
      fullname: raw.fullName || raw.fullname || raw.name || '',
      role: raw.role || raw.Role || '',
      email: raw.email || raw.Email || '',
      passwordHash: raw.passwordHash || raw.password || '',
      createdAt: raw.createdAt || raw.created || nowIso(),
      status: raw.status || 'active',
      _originKey: raw._originKey || null,
      _type: 'employee'
    };
  }
  return {
    id: raw.id || raw.studentNumber || generateId(),
    studentNumber: raw.studentNumber || raw.StudentNumber || raw.studentId || raw.studentNo || '',
    fullname: raw.fullName || raw.fullname || raw.FullName || raw.name || '',
    email: raw.email || raw.Email || '',
    dateOfBirth: raw.dateOfBirth || raw.DOB || raw.dob || '',
    address: raw.address || raw.Address || '',
    accountType: raw.accountType || raw.AccountType || '',
    passwordHash: raw.passwordHash || raw.password || raw.passwordHash || '',
    createdAt: raw.createdAt || raw.created || raw.dateRegistered || nowIso(),
    status: raw.status || 'active',
    _originKey: raw._originKey || null,
    _type: 'student'
  };
}

// ---------- LocalStorage helpers ----------
function loadFromPossibleKeys(keys, type){
  const result = [];
  keys.forEach(key => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return;
      arr.forEach(item => {
        const n = normalize(item, type);
        if (!n._originKey) n._originKey = key;
        if (!n.id) n.id = generateId();
        result.push(n);
      });
    } catch(e){ /* ignore malformed */ }
  });

  for (let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if (!key || keys.includes(key)) continue;
    try {
      const raw = localStorage.getItem(key);
      if (!raw) continue;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        const isEmployee = type === 'employee' && (parsed.employeeId || parsed.role || parsed.fullName || parsed.fullName === '');
        const isStudent = type === 'student' && (parsed.studentNumber || parsed.studentId || parsed.fullName || parsed.fullName === '');
        if (isEmployee || isStudent) {
          const n = normalize(parsed, type);
          if (!n._originKey) n._originKey = key;
          if (!n.id) n.id = generateId();
          const exists = result.find(x => (x.employeeId && x.employeeId === n.employeeId) || (x.studentNumber && x.studentNumber === n.studentNumber) || (x.id && x.id === n.id));
          if (!exists) result.push(n);
        }
      }
    } catch(e){ /* skip */ }
  }

  const dedup = [];
  const seen = new Set();
  result.forEach(r => {
    const key = (r.employeeId || r.studentNumber || r.id || '') + '|' + (r.email || '');
    if (!seen.has(key)){
      seen.add(key);
      dedup.push(r);
    }
  });

  return dedup;
}

function saveToLocalOrigin(item, type){
  const keys = type === 'employee' ? POSSIBLE_EMPLOYEE_KEYS : POSSIBLE_STUDENT_KEYS;
  const origin = item._originKey || keys[0];
  let arr = [];
  try { arr = JSON.parse(localStorage.getItem(origin) || '[]'); } catch(e){ arr = []; }
  const idx = arr.findIndex(x => (x.employeeId && x.employeeId === item.employeeId) || (x.studentNumber && x.studentNumber === item.studentNumber) || (x.id && x.id === item.id));
  const toSave = Object.assign({}, item);
  delete toSave._originKey;
  delete toSave._type;
  if (idx === -1) arr.push(toSave); else arr[idx] = Object.assign({}, arr[idx], toSave);
  localStorage.setItem(origin, JSON.stringify(arr));
  item._originKey = origin;
}

function deleteFromLocalOrigin(item, type){
  const keys = type === 'employee' ? POSSIBLE_EMPLOYEE_KEYS : POSSIBLE_STUDENT_KEYS;
  const origin = item._originKey || keys[0];
  try {
    let arr = JSON.parse(localStorage.getItem(origin) || '[]');
    const idx = arr.findIndex(x => (x.employeeId && x.employeeId === item.employeeId) || (x.studentNumber && x.studentNumber === item.studentNumber) || (x.id && x.id === item.id));
    if (idx !== -1) {
      arr.splice(idx,1);
      localStorage.setItem(origin, JSON.stringify(arr));
    }
  } catch(e){ console.error(e); }
}

// ---------- Users (login) helpers ----------
function loadUsers(){
  try {
    const raw = localStorage.getItem(USERS_KEY) || '[]';
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch(e){ return []; }
}
function saveUsers(arr){
  try { localStorage.setItem(USERS_KEY, JSON.stringify(arr)); } catch(e){ console.error(e); }
}

function addOrUpdateUserCredentials(item, type){
  if (!item || !(item.studentNumber || item.employeeId)) return;
  const users = loadUsers();
  const idx = users.findIndex(u => u.studentNumber === item.studentNumber || u.employeeId === item.employeeId);
  const userRecord = {
    studentNumber: item.studentNumber || '',
    employeeId: item.employeeId || '',
    fullname: item.fullname || item.fullName || '',
    email: item.email || '',
    passwordHash: item.passwordHash || item.password || '',
    _type: type
  };
  if (idx === -1) users.push(userRecord); else users[idx] = Object.assign({}, users[idx], userRecord);
  saveUsers(users);
}

function removeUserCredentials(item, type){
  if (!item || !(item.studentNumber || item.employeeId)) return;
  const users = loadUsers();
  const idx = users.findIndex(u => u.studentNumber === item.studentNumber || u.employeeId === item.employeeId);
  if (idx !== -1){ users.splice(idx,1); saveUsers(users); }
}

// ---------- Optional API helpers ----------
async function apiGetItems(type){
  if(!apiBaseUrl) throw new Error('no api configured');
  const endpoint = type === 'employee' ? `${apiBaseUrl}/employees` : apiBaseUrl;
  const r = await fetch(endpoint);
  if (!r.ok) throw new Error(`api GET ${type} failed`);
  const arr = await r.json();
  return (Array.isArray(arr) ? arr : []).map(item => normalize(item, type));
}
async function apiPostItem(item, type){
  if(!apiBaseUrl) throw new Error('no api configured');
  const endpoint = type === 'employee' ? `${apiBaseUrl}/employees` : apiBaseUrl;
  const r = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(item) });
  if(!r.ok) throw new Error(`api POST ${type} failed`);
  const created = await r.json();
  return normalize(created, type);
}
async function apiPutItem(item, type){
  if(!apiBaseUrl) throw new Error('no api configured');
  const endpoint = type === 'employee' ? `${apiBaseUrl}/employees` : apiBaseUrl;
  const id = encodeURIComponent(item.employeeId || item.studentNumber || item.id);
  const r = await fetch(`${endpoint}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(item) });
  if(!r.ok) throw new Error(`api PUT ${type} failed`);
  const updated = await r.json();
  return normalize(updated, type);
}
async function apiDeleteItem(item, type){
  if(!apiBaseUrl) throw new Error('no api configured');
  const endpoint = type === 'employee' ? `${apiBaseUrl}/employees` : apiBaseUrl;
  const id = encodeURIComponent(item.employeeId || item.studentNumber || item.id);
  const r = await fetch(`${endpoint}/${id}`, { method:'DELETE' });
  if(!r.ok) throw new Error(`api DELETE ${type} failed`);
  return true;
}

// ---------- UI & State ----------
const studentTbody = document.querySelector('#studentsTable tbody');
const employeeTbody = document.querySelector('#employeesTable tbody');
const totalStudentsEl = document.getElementById('totalStudents');
const newStudentsMonthEl = document.getElementById('newThisMonth');
const pendingStudentsEl = document.getElementById('pendingStudents');
const totalEmployeesEl = document.getElementById('totalEmployees');
const newEmployeesMonthEl = document.getElementById('newEmployeesThisMonth');
const pendingEmployeesEl = document.getElementById('pendingEmployees');
const searchStudentInput = document.getElementById('searchStudent');
const searchEmployeeInput = document.getElementById('searchEmployee');

let studentsCache = [];
let employeesCache = [];

function renderTable(type){
  const tbody = type === 'employee' ? employeeTbody : studentTbody;
  const searchInput = type === 'employee' ? searchEmployeeInput : searchStudentInput;
  const cache = type === 'employee' ? employeesCache : studentsCache;
  const totalEl = type === 'employee' ? totalEmployeesEl : totalStudentsEl;
  const newMonthEl = type === 'employee' ? newEmployeesMonthEl : newStudentsMonthEl;
  const pendingEl = type === 'employee' ? pendingEmployeesEl : pendingStudentsEl;

  const q = (searchInput.value || '').trim().toLowerCase();
  tbody.innerHTML = '';
  const filtered = cache.filter(item => {
    if (!q) return true;
    if (type === 'employee') {
      return (item.fullname || '').toLowerCase().includes(q) || (String(item.employeeId || '')).toLowerCase().includes(q) || (item.role || '').toLowerCase().includes(q);
    }
    return (item.fullname || '').toLowerCase().includes(q) || (String(item.studentNumber || '')).toLowerCase().includes(q) || (item.email || '').toLowerCase().includes(q);
  });

  filtered.forEach(item => {
    const tr = document.createElement('tr');
    if (type === 'employee') {
      tr.innerHTML = `
        <td>${escapeHtml(item.employeeId)}</td>
        <td>${escapeHtml(item.fullname)}</td>
        <td>${escapeHtml(item.role)}</td>
        <td class="action-icons">
          <button class="edit" data-id="${item.id}" data-type="employee" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="delete" data-id="${item.id}" data-type="employee" title="Delete"><i class="fas fa-trash"></i></button>
        </td>
      `;
    } else {
      tr.innerHTML = `
        <td>${escapeHtml(item.studentNumber)}</td>
        <td>${escapeHtml(item.fullname)}</td>
        <td>${escapeHtml(item.email)}</td>
        <td class="action-icons">
          <button class="edit" data-id="${item.id}" data-type="student" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="delete" data-id="${item.id}" data-type="student" title="Delete"><i class="fas fa-trash"></i></button>
        </td>
      `;
    }
    tbody.appendChild(tr);
  });

  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const newThisMonth = cache.filter(item => {
    const d = new Date(item.createdAt || nowIso());
    return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
  }).length;
  const pending = cache.filter(item => (item.status || '').toLowerCase() === 'pending').length;

  totalEl.innerText = cache.length;
  newMonthEl.innerText = newThisMonth;
  pendingEl.innerText = pending;
}

// Load items (API preferred, fallback to localStorage)
async function loadItems(type){
  const keys = type === 'employee' ? POSSIBLE_EMPLOYEE_KEYS : POSSIBLE_STUDENT_KEYS;
  try {
    if (apiBaseUrl) {
      try {
        const apiList = await apiGetItems(type);
        const cache = apiList.map(x => Object.assign({}, x, {_originKey:'api'}));
        if (type === 'employee') employeesCache = cache; else studentsCache = cache;
        renderTable(type);
        return;
      } catch(e){
        console.warn(`API fetch failed for ${type} — falling back to local storage`, e);
      }
    }
    const cache = loadFromPossibleKeys(keys, type);
    if (type === 'employee') employeesCache = cache; else studentsCache = cache;
    if (!localStorage.getItem(keys[0])) localStorage.setItem(keys[0], JSON.stringify([]));
    renderTable(type);
  } catch(e){
    console.error(e);
  }
}

// ---------- Section Switching ----------
function switchSection(target) {
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.menu-item').forEach(item => {
    item.classList.remove('active');
  });
  document.getElementById(target).classList.add('active');
  document.querySelector(`.menu-item[data-target="${target}"]`).classList.add('active');
}

document.querySelectorAll('.menu-item').forEach(item => {
  item.addEventListener('click', () => {
    const target = item.getAttribute('data-target');
    switchSection(target);
  });
});

// ---------- Add Student ----------
document.getElementById('addStudentBtn').addEventListener('click', async () => {
  const studentNumber = prompt('Student Number:');
  if (!studentNumber) return;
  const fullname = prompt('Full Name:');
  if (!fullname) return;
  const email = prompt('Email:');
  if (!email) return;
  const password = prompt('Password (temporary):') || '';

  if (studentsCache.find(s => String(s.studentNumber) === String(studentNumber))) {
    return alert('A student with that number already exists.');
  }

  const studentObj = normalize({
    studentNumber,
    fullName: fullname,
    email,
    passwordHash: password,
    createdAt: nowIso(),
    status: 'active'
  }, 'student');

  try {
    if (apiBaseUrl) {
      try {
        const created = await apiPostItem(studentObj, 'student');
        created._originKey = 'api';
        studentsCache.push(created);
        addOrUpdateUserCredentials(created, 'student');
        renderTable('student');
        return alert('Student created via API (and local user credentials added).');
      } catch(apiErr){
        console.warn('API create failed — saving locally instead', apiErr);
      }
    }
    saveToLocalOrigin(studentObj, 'student');
    addOrUpdateUserCredentials(studentObj, 'student');
    studentsCache.push(studentObj);
    renderTable('student');
    alert('Student added to frontend storage and credentials saved (student can now log in).');
  } catch(err){
    console.error(err);
    alert('Failed to add student.');
  }
});

// ---------- Add Employee ----------
document.getElementById('addEmployeeBtn').addEventListener('click', async () => {
  const employeeId = prompt('Employee ID:');
  if (!employeeId) return;
  const fullname = prompt('Full Name:');
  if (!fullname) return;
  const role = prompt('Role:');
  if (!role) return;
  const email = prompt('Email:');
  if (!email) return;
  const password = prompt('Password (temporary):') || '';

  if (employeesCache.find(e => String(e.employeeId) === String(employeeId))) {
    return alert('An employee with that ID already exists.');
  }

  const employeeObj = normalize({
    employeeId,
    fullName: fullname,
    role,
    email,
    passwordHash: password,
    createdAt: nowIso(),
    status: 'active'
  }, 'employee');

  try {
    if (apiBaseUrl) {
      try {
        const created = await apiPostItem(employeeObj, 'employee');
        created._originKey = 'api';
        employeesCache.push(created);
        addOrUpdateUserCredentials(created, 'employee');
        renderTable('employee');
        return alert('Employee created via API (and local user credentials added).');
      } catch(apiErr){
        console.warn('API create failed — saving locally instead', apiErr);
      }
    }
    saveToLocalOrigin(employeeObj, 'employee');
    addOrUpdateUserCredentials(employeeObj, 'employee');
    employeesCache.push(employeeObj);
    renderTable('employee');
    alert('Employee added to frontend storage and credentials saved (employee can now log in).');
  } catch(err){
    console.error(err);
    alert('Failed to add employee.');
  }
});

// ---------- Edit / Delete (delegated) ----------
document.querySelector('.content').addEventListener('click', async (e) => {
  const editBtn = e.target.closest('button.edit');
  const delBtn = e.target.closest('button.delete');

  if (editBtn) {
    const id = editBtn.getAttribute('data-id');
    const type = editBtn.getAttribute('data-type');
    const cache = type === 'employee' ? employeesCache : studentsCache;
    const item = cache.find(x => x.id === id);
    if (!item) return alert(`${type} not found.`);

    if (type === 'employee') {
      const newName = prompt('Full name:', item.fullname) || item.fullname;
      const newRole = prompt('Role:', item.role) || item.role;
      const newEmail = prompt('Email:', item.email) || item.email;

      const updated = Object.assign({}, item, {
        fullname: newName.trim(),
        role: newRole.trim(),
        email: newEmail.trim()
      });

      try {
        if (updated._originKey === 'api' && apiBaseUrl) {
          try {
            const res = await apiPutItem(updated, 'employee');
            res._originKey = 'api';
            const idx = employeesCache.findIndex(x => x.id === id);
            if (idx !== -1) employeesCache[idx] = res;
            addOrUpdateUserCredentials(res, 'employee');
            renderTable('employee');
            return alert('Updated via API (user credentials updated locally as well).');
          } catch(apiErr){
            console.warn('API update failed, saving locally instead', apiErr);
          }
        }
        saveToLocalOrigin(updated, 'employee');
        addOrUpdateUserCredentials(updated, 'employee');
        const idx = employeesCache.findIndex(x => x.id === id);
        if (idx !== -1) employeesCache[idx] = updated;
        renderTable('employee');
        alert('Employee updated.');
      } catch(err){
        console.error(err);
        alert('Failed to update employee.');
      }
    } else {
      const newName = prompt('Full name:', item.fullname) || item.fullname;
      const newEmail = prompt('Email:', item.email) || item.email;

      const updated = Object.assign({}, item, {
        fullname: newName.trim(),
        email: newEmail.trim()
      });

      try {
        if (updated._originKey === 'api' && apiBaseUrl) {
          try {
            const res = await apiPutItem(updated, 'student');
            res._originKey = 'api';
            const idx = studentsCache.findIndex(x => x.id === id);
            if (idx !== -1) studentsCache[idx] = res;
            addOrUpdateUserCredentials(res, 'student');
            renderTable('student');
            return alert('Updated via API (user credentials updated locally as well).');
          } catch(apiErr){
            console.warn('API update failed, saving locally instead', apiErr);
          }
        }
        saveToLocalOrigin(updated, 'student');
        addOrUpdateUserCredentials(updated, 'student');
        const idx = studentsCache.findIndex(x => x.id === id);
        if (idx !== -1) studentsCache[idx] = updated;
        renderTable('student');
        alert('Student updated.');
      } catch(err){
        console.error(err);
        alert('Failed to update student.');
      }
    }
  }

  if (delBtn) {
    const id = delBtn.getAttribute('data-id');
    const type = delBtn.getAttribute('data-type');
    const cache = type === 'employee' ? employeesCache : studentsCache;
    const item = cache.find(x => x.id === id);
    if (!item) return alert(`${type} not found.`);
    if (!confirm(`Delete ${item.fullname} (${item.employeeId || item.studentNumber})?`)) return;

    try {
      if (item._originKey === 'api' && apiBaseUrl) {
        try {
          await apiDeleteItem(item, type);
          if (type === 'employee') employeesCache = employeesCache.filter(x => x.id !== id);
          else studentsCache = studentsCache.filter(x => x.id !== id);
          removeUserCredentials(item, type);
          renderTable(type);
          return alert(`Deleted via API (credentials removed locally).`);
        } catch(apiErr){
          console.warn(`API delete failed, falling back to local delete`, apiErr);
        }
      }
      deleteFromLocalOrigin(item, type);
      removeUserCredentials(item, type);
      if (type === 'employee') employeesCache = employeesCache.filter(x => x.id !== id);
      else studentsCache = studentsCache.filter(x => x.id !== id);
      renderTable(type);
      alert(`Deleted from frontend storage (credentials removed).`);
    } catch(err){
      console.error(err);
      alert(`Failed to delete ${type}.`);
    }
  }
});

// ---------- Search ----------
document.getElementById('searchBtn').addEventListener('click', () => renderTable('student'));
searchStudentInput.addEventListener('input', () => renderTable('student'));
document.getElementById('searchEmployeeBtn').addEventListener('click', () => renderTable('employee'));
searchEmployeeInput.addEventListener('input', () => renderTable('employee'));

// ---------- Init ----------
window.addEventListener('DOMContentLoaded', () => {
  loadItems('student');
  loadItems('employee');
});
</script>
</body>
</htm